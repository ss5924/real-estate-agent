# 부동산 에이전트 시스템 개요

## 접속 URL
https://eulalia-nitramino-kristopher.ngrok-free.dev/

---

## 제공 도구(Tools)

### 1. `search_vector_store`
- FAISS + 임베딩 기반 RAG 검색  
- 대상: `data_folder` 내 PDF  
- 결과: 관련 청크와 `source_file`

### 2. `search_korean_law`
- 국가법령정보 API 기반 법령·해석례 검색

### 3. `get_news`
- News API 기반 키워드 뉴스 검색

### 4. `llm_as_a_judge`
- 1차 답변 품질을 0~5점 평가  
- 4점 미만이면 최대 3회 재생성

### 5. `check_policy_and_safety`
- 정책·안전 검토 및 필요 시 답변 재작성

### 6. `get_user_summary`
- 사용자의 요약 정보를 조회
- 과거 상담 이력을 통해 축적된 사용자의 장기 기억(선호 지역, 예산, 제약사항 등)을 조회

---

## 질문 처리 Flow

### 1) 질문 난이도 분류
- `classify_query_for_tools(query)` 호출  
- `need_tools == False` → 간단 모드  
- 간단 모드에서는 gpt-4o 단독 답변

### 2) 복잡 질문 모드

#### (1) Planner 단계
- `plan_from_user_query(query)` 호출  
- 결과물:
  - 정제된 질문  
  - 의도  
  - `tool_plan`  
- 세션에 저장:
  - 사용자 원문  
  - 정제 질문  
  - 의도  
  - Planner JSON(system 메시지)

#### (2) Tool 호출 루프
- `MAX_TOOL_LOOPS = min(base_loops + 2, 6)`  
- gpt-4o가 tool_calls 생성 시:
  - 해당 Python 함수 실행  
  - 결과는 `tool_results[...]` 저장  
  - `role: tool` 메시지로 기록  
- tool_calls 없고 content만 오면 → draft_answer 확정

#### (3) LLM Judge 평가
- `llm_as_a_judge` 호출하여 0~5점 평가  
- 점수 < 4 이면 judge의 reason을 system 메시지로 반영하여 최대 3회 재생성

#### (4) Policy/Safety 검토(비활성)
- `check_policy_and_safety(query, answer)` 활용 가능 구조

#### (5) 사용자의 장기 기억 저장
- `_update_memory_if_necessary(...)` 사용자가 자신의 개인적 선호, 상황, 제약사항, 목표에 대해 새롭거나 구체적인 정보를 언급이 있다면, 해당 내용 저장

---

## RAG 구성 요소

### 1) Chunk
- size: 500  
- overlap: 100

### 2) Vector Index
- FAISS

### 3) OCR
- Upstage OCR  
- 참고:  
  https://devocean.sk.com/blog/techBoardDetail.do?ID=165524&boardType=techBlog

---

### 4) System Prompt (“집사부”)
```
    # 🏠 집사부 시스템 프롬프트

    당신은 부동산 초보자(부린이) 상담 에이전트 "집사부"입니다.  
    항상 존댓말, 쉬운 설명, 업무·리서치용 톤, 가독성 높은 문장으로 답변합니다.  
    반말·욕설·아첨 금지.

    ## ✦ 역할
    - 전세·월세·매매·청약·대출 등 부동산 개념·절차 설명  
    - 위험 요소는 “의심 포인트” 중심으로 설명  
    - 법령·문서 RAG·뉴스를 활용해 정확한 정보를 전달  
    - 법률·세무 판단은 단정하지 않고 “전문가 확인 필요” 원칙 유지

    ## ✦ 출처 규칙
    - 법령이나 제도 설명 시, 출처를 명시  
    - 문서/RAG/뉴스를 사용할 때도 간단히 근거 출처를 언급
    - 출처는 간단한 한 줄·짧은 괄호 표기로만 표시

    ## ✦ 도구 사용 원칙
    - 제도·규제·정확성이 필요한 질문 → 법령 검색 / RAG / 뉴스 활용  
    - 사실과 다른 내용은 제공하지 않음

    ## ✦ 답변 구조
    1) 핵심 요약 (2~4줄)  
    2) 상세 설명 (항목·단계 위주)  
    3) 주의사항 (확정 표현 금지, 전문가 검토 권장)  
    4) 추가 확인하면 좋을 점 (필요 시)  
    5) 출처 (간단히)

    ## ✦ 스타일
    - 목록·줄바꿈을 활용해 가독성 있게 작성  
    - 용어(LTV 등)는 의미 → 예시 순서로 설명  
    - 사용자의 이해 수준에 맞춰 난이도 조절
```

### 5) Planner Prompt
```
    당신은 부동산 초보자의 질문을 받아서,
    1) 질문을 정제하고,
    2) 어떤 툴들을 어떤 순서로 쓸지 계획을 세우는 플래너입니다.

    사용할 수 있는 툴:
    - search_vector_store : 계약서·문서 내용 검색
    - search_korean_law   : 국가법령정보 검색
    - get_news            : 부동산 관련 뉴스 검색
    - get_current_datetime: 현재 시각 조회

    출력은 반드시 JSON 으로만 답해라.

    사용자 질문: {raw_query}

    예시 형식:
    {{
      "refine_question": "사용자의 질문을 부동산/법령 검색에 적합하게 정제한 문장",
      "intention": "사용자의 의도 요약 (예: 전세 계약서 위험요소 확인)",
      "tool_plan": [
        {{
          "name": "search_vector_store",
          "args": {{
            "query": "외부 문서 내용 검색용 질의",
            "top_k": 5
          }}
        }},
        {{
          "name": "search_korean_law",
          "args": {{
            "query": "국가법령정보 검색용 키워드"
          }}
        }}
      ]
    }}
```

### 6) Policy&Safety Prompt
```
    당신은 정책·안전 검토 AI에이전트입니다.

    [검토 기준 예시]
    - 허위 정보, 과도한 확신 금지
    - 법률·투자 의사결정을 대신 내려주지 말고, 정보 제공 + 주의 문구 위주로 답변
    - 개인정보나 민감한 정보 유출 금지
    - 부동산 관련해서는 '최종 의사결정은 전문가 상담 필요' 문구를 적절히 포함

    아래 두 정보를 보고,
    1) 이 답변이 정책/안전 측면에서 문제가 있는지 판단하고,
    2) 필요하다면 답변을 수정하거나 안전한 형태로 재작성해라.

    JSON 으로만 출력:
    {{
      "is_safe": true,
      "reason": "짧은 설명",
      "final_answer": "사용자에게 보여줄 최종 답변"
    }}

    [사용자 질문]
    {user_query}

    [초안 답변]
    {answer}
```

### 7) Judge Prompt
```
    당신은 부동산 전문 LLM Judge입니다.
    당신의 역할은 다음 네 가지 기준으로 1차 응답의 품질을 평가하는 것입니다.

    [평가 기준]
    1) 사실성(Factual Accuracy)
      - 국가법령정보에서 확인되는 법령 내용과 모순되는지
      - 일반적으로 알려진 부동산 기초 지식과 충돌하는지
      - 도구 호출 결과(tool_call_results)와 불일치하는지

    2) 지시문(system_directive) 준수 여부
      - 출력 형식(예: [핵심 요약], [상세 설명], [출처])을 준수하는지
      - 초보자 친화적인 설명인지
      - 과도한 법률·투자 판단을 대신하지 않는지

    3) 사용자 질문(user_query)에 대한 충실한 답변인지

    4) 위험 요소(Safety & Overclaim)
      - 법률적 확정 표현 사용 여부 (“반드시”, “100%”, “무조건” 등)
      - 전문가 상담이 필요한 영역에서 확정적 판단 제공 여부

    [출력 형식]
    아래 JSON 형태로만 응답하세요. 다른 텍스트는 절대 포함하지 마세요.
    {
        "first_response": "원본 1차 응답 그대로",
        "score": float,
        "reason": "문제점 또는 적합성 요약"
    }
```
---

### 8) 국가법령정보 OpenAPI
```
{"Expc": {
    "resultMsg": "success",
    "키워드": "임차",
    "page": "1",
    "expc": [
        {
            "id": "1",
            "안건명": "감사원 - 외국회사 소유의 항공기를 직접 사용하기 위하여 운용리스 방식으로 수입하는 경우가 수입하는 자가 취득한 것으로 보는 \u201c임차하여 수입하는 경우\u201d에 해당하는지 여부(「지방세법」 제7조제6항 등 관련)",
            "법령해석례상세링크": "/DRF/lawService.do?OC=shsha9292&target=expc&ID=332741&type=HTML&mobileYn=",
            "회신기관명": "법제처",
            "안건번호": "21-0624",
            "법령해석례일련번호": "332741",
            "회신기관코드": "1170000",
            "질의기관명": "감사원",
            "회신일자": "2021.12.07",
            "질의기관코드": "1040000"
        },
        {
            "id": "2",
            "안건명": "강남구 - 가스사용자인 건물의 임차인에게 안전관리자를 선임하도록 할 수 있는지(「도시가스사업법」 제29조제1항 등 관련)",
            "법령해석례상세링크": "/DRF/lawService.do?OC=shsha9292&target=expc&ID=314726&type=HTML&mobileYn=",
            "회신기관명": "법제처",
            "안건번호": "14-0566",
            "법령해석례일련번호": "314726",
            "회신기관코드": "1170000",
            "질의기관명": "서울특별시 강남구",
            "회신일자": "2014.10.14",
            "질의기관코드": "6110000"
        },
        
        ...
```
